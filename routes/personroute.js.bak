var express = require('express');
var personrouter = express.Router();


var person = require('../dbmodels/personDAO.js');
	 //console.log('person数据模型是否存在：'+person);

var personAdd = function(req, res) {
if(req.params.name){//update
return res.render('person', {
title:req.params.name+'|电影|管理|moive.me',
label:'编辑电影:'+req.params.name,
person:req.params.name
});
} else {
return res.render('person',{
title:'新增加|电影|管理|moive.me',
label:'新增加电影',
person:false
});
}
};



var dopersonAdd = function(req, res) {
	
 //console.log("请求内容："+req+'<>person name in body:'+req.body.name+'<>method:'+req.method);

//req.body.data=personTestData;
//for(var i in req.body){ //console.log("请求内容子项："+i+"<>")};

var json = req.body;
//var json =personTestData;
 //console.log('json._id>'+json._id);
if(json._id){	
} else {//insert
	
 //console.log('调用了dopersonAdd方法');

person.save(json, function(err){
if(err) {
res.send({'success':false,'err':err});
} else {
res.send({'success':true});
}
});/**/
}
};

var dopersonEdit = function(req, res) {
	
 //console.log("请求内容："+req+'<>person name in body:'+req.body.name+'<>method:'+req.method);

//req.body.data=personTestData;
//for(var i in req.body){ //console.log("请求内容子项："+i+"<>")};

var json = req.body;
//var json =personTestData;
 //console.log('json._id>'+json._id);
if(json._id){//update	
 //console.log('调用了dopersonEdit方法');
person.updateById(json, function(err){
if(err) {
res.send({'success':false,'err':err});
} else {
res.send({'success':true});
}
});/**/	
	
} else {//insert

}
};

var personJSON = function(req, res) {
 //console.log('调用了personJSON方法 by params');
//for(var i in req.params){ //console.log("请求内容params子项："+i+"<>\n")};
person.findByMobile(req.params.mobile,function(err, obj){
res.send(obj);
});
}

//添加人员位置
var personAddLocation = function(req, res) {
 //console.log('调用了personAddLocation方法 by params:'+req.params);
//for(var i in req.params){ //console.log("请求内容params子项："+i+"<>")};
//for(var i in req.body){ //console.log("请求内容body子项："+i+"<>\n")};
person.addNewLocation(req.body.personid,req.body.curlocation,function(err, obj){
	if(err){
		res.send(err);
		}
	else {		
		res.send(err);
	}
});
}


var personAddByIDCard= function(req, res) {
 //console.log('调用了personAddByIDCard方法 by params:'+req.params);
//for(var i in req.params){ //console.log("请求内容params子项："+i+"<>")};
//for(var i in req.body){ //console.log("请求内容body子项："+i+"<>\n")};

var json=req.body;
				 //console.log('用户findByMobile UUid :'+json.mobileUUid);
person.findByMobileUUid(json.mobileUUid,function(err, obj){
	//根据uuid查询用户
	//如果出错
	if (err) {
		
				 //console.log('用户findByMobileUUid err:'+err);
	}
	//如果没有错
	else {
		//如果查出这个UUID已有用户
		if (obj) {
				 //console.log('用户findByMobileUUid obj:'+obj.name);
		}
		//如果没有用户就开始存
		else {
				 //console.log('用户idNum:'+json.idNum);
			//如果身份证号不为空，这个后面还得加验证
			if (json.idNum) {
				person.save(json, function(err,savedobj){
				if(err) {
				 //console.log('用户save err:'+err);
				res.send({'success':false,'err':err});
				} else {
					
				 //console.log('用户已注册成功:'+json.idNum);
				res.send({'success':true,"_id":savedobj._id});
				}
				});/**/
			}

		}
	}
});

}



var getPersonByUUId = function(req, res) {
 //console.log('调用了getPersonByUUId方法 by params');
//for(var i in req.body){ //console.log("请求内容body子项："+i+"<>\n")};
if (req.body.mobileUUid) {
	
 //console.log('req.body.mobileUUid:'+req.body.mobileUUid);
	person.findByMobileUUid(req.body.mobileUUid,function(err, obj){
		if(err) {
				 //console.log('rgetPersonByUUId查询出差');
				res.send({'success':false,'err':err});
				} else if (obj) {
						
				 //console.log('req.body.mobileUUid查询用户成功:'+obj.name);
				res.send(obj);
					}else {							
	res.send(null);
						}});
}else {
	res.send(null);
}

}

personrouter.get('/add',personAdd);//增加
personrouter.post('/add',dopersonAdd);//提交
personrouter.post('/edit',dopersonEdit);//提交
personrouter.options('/add',dopersonAdd);//提交
personrouter.get('/:mobile',personJSON);//编辑查询
personrouter.post('/addlocation',personAddLocation);//提交
personrouter.post('/registerByIdcard',personAddByIDCard);//提交
personrouter.post('/getPersonByUUId',getPersonByUUId);//提交

module.exports = personrouter;